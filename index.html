import React, { useState, useEffect, useRef, useMemo } from 'react';
import { Map as MapIcon, MapPin, Users, Navigation, Search, Info, X, TrendingUp, Layers } from 'lucide-react';

// --- DATA SET ---
const CITIES = [
  { id: 1, name: 'Berlin', population: 3664000, state: 'Berlin', lat: 52.52, lon: 13.40, vibe: 'Techno & History', color: '#ec4899' },
  { id: 2, name: 'Hamburg', population: 1852000, state: 'Hamburg', lat: 53.55, lon: 9.99, vibe: 'Harbor & Bricks', color: '#38bdf8' },
  { id: 3, name: 'München', population: 1488000, state: 'Bayern', lat: 48.13, lon: 11.58, vibe: 'Laptops & Lederhosen', color: '#3b82f6' },
  { id: 4, name: 'Köln', population: 1083000, state: 'NRW', lat: 50.93, lon: 6.96, vibe: 'Carnival & Cathedral', color: '#f97316' },
  { id: 5, name: 'Frankfurt', population: 764000, state: 'Hessen', lat: 50.11, lon: 8.68, vibe: 'Banks & Skyscrapers', color: '#10b981' },
  { id: 6, name: 'Stuttgart', population: 630000, state: 'Ba-Wü', lat: 48.77, lon: 9.18, vibe: 'Cars & Vineyards', color: '#eab308' },
  { id: 7, name: 'Düsseldorf', population: 620000, state: 'NRW', lat: 51.22, lon: 6.77, vibe: 'Fashion & Altbier', color: '#a855f7' },
  { id: 8, name: 'Leipzig', population: 601000, state: 'Sachsen', lat: 51.33, lon: 12.37, vibe: 'Hypezig & Culture', color: '#f59e0b' },
  { id: 9, name: 'Dortmund', population: 586000, state: 'NRW', lat: 51.51, lon: 7.46, vibe: 'Football & Steel', color: '#facc15' },
  { id: 10, name: 'Essen', population: 582000, state: 'NRW', lat: 51.45, lon: 7.01, vibe: 'Green Capital & Coal', color: '#22c55e' },
  { id: 11, name: 'Bremen', population: 566000, state: 'Bremen', lat: 53.07, lon: 8.80, vibe: 'Musicians & Space', color: '#ef4444' },
  { id: 12, name: 'Dresden', population: 556000, state: 'Sachsen', lat: 51.05, lon: 13.73, vibe: 'Baroque & Future', color: '#f97316' },
  { id: 13, name: 'Hannover', population: 535000, state: 'Niedersachsen', lat: 52.37, lon: 9.73, vibe: 'Expo & Gardens', color: '#4ade80' },
  { id: 14, name: 'Nürnberg', population: 515000, state: 'Bayern', lat: 49.45, lon: 11.07, vibe: 'Toys & Castle', color: '#dc2626' },
  { id: 15, name: 'Duisburg', population: 495000, state: 'NRW', lat: 51.43, lon: 6.76, vibe: 'Logistics & Water', color: '#64748b' },
  { id: 16, name: 'Bochum', population: 363000, state: 'NRW', lat: 51.48, lon: 7.21, vibe: 'Mining & Musical', color: '#3b82f6' },
  { id: 17, name: 'Wuppertal', population: 355000, state: 'NRW', lat: 51.25, lon: 7.19, vibe: 'Suspension Railway', color: '#14b8a6' },
  { id: 18, name: 'Bielefeld', population: 334000, state: 'NRW', lat: 52.03, lon: 8.53, vibe: 'Does it exist?', color: '#94a3b8' },
  { id: 19, name: 'Bonn', population: 331000, state: 'NRW', lat: 50.73, lon: 7.09, vibe: 'Politics & Beethoven', color: '#6366f1' },
  { id: 20, name: 'Münster', population: 317000, state: 'NRW', lat: 51.96, lon: 7.62, vibe: 'Bicycles & Students', color: '#84cc16' },
  { id: 21, name: 'Karlsruhe', population: 308000, state: 'Ba-Wü', lat: 49.00, lon: 8.40, vibe: 'Justice & Tech', color: '#f59e0b' },
  { id: 22, name: 'Mannheim', population: 311000, state: 'Ba-Wü', lat: 49.48, lon: 8.46, vibe: 'Grid City & Pop', color: '#d946ef' },
  { id: 23, name: 'Augsburg', population: 296000, state: 'Bayern', lat: 48.37, lon: 10.89, vibe: 'Fugger & Renaissance', color: '#fb923c' },
  { id: 24, name: 'Wiesbaden', population: 278000, state: 'Hessen', lat: 50.07, lon: 8.23, vibe: 'Spa & Casino', color: '#2dd4bf' },
  { id: 25, name: 'Kiel', population: 246000, state: 'SH', lat: 54.32, lon: 10.12, vibe: 'Sailing & Navy', color: '#06b6d4' },
];

// --- GEOJSON: Accurate Political Borders of Germany (Simplified) ---
// Coordinates are [Longitude, Latitude]
const GERMANY_BORDER_GEOJSON = {
  "type": "Feature",
  "geometry": {
    "type": "Polygon",
    "coordinates": [[
      [6.0, 50.8], [6.1, 51.2], [6.0, 51.8], [6.6, 51.9], [6.9, 52.3], [7.1, 53.0], 
      [7.2, 53.6], [8.0, 53.8], [8.7, 53.9], [8.5, 54.9], [8.4, 55.0], [9.4, 54.8], 
      [9.9, 54.6], [10.4, 54.4], [11.1, 54.4], [11.3, 54.0], [11.9, 54.2], [12.6, 54.4], 
      [13.6, 54.6], [14.1, 53.9], [14.4, 53.6], [14.2, 53.0], [14.5, 52.6], [14.7, 52.2], 
      [14.8, 51.8], [15.0, 51.3], [15.0, 51.0], [14.8, 50.9], [14.2, 50.9], [14.0, 50.6], 
      [13.5, 50.6], [13.2, 50.4], [12.9, 50.2], [12.4, 50.2], [12.2, 50.0], [12.3, 49.8], 
      [12.5, 49.5], [13.0, 49.2], [13.6, 49.0], [13.8, 48.8], [13.7, 48.6], [13.3, 48.4], 
      [13.0, 48.2], [12.9, 47.9], [13.0, 47.6], [12.9, 47.5], [12.5, 47.7], [12.2, 47.5], 
      [11.8, 47.6], [11.5, 47.4], [11.3, 47.3], [11.0, 47.4], [10.5, 47.3], [10.2, 47.3], 
      [10.0, 47.5], [9.6, 47.5], [9.5, 47.6], [9.0, 47.7], [8.5, 47.6], [8.0, 47.6], 
      [7.6, 47.5], [7.6, 47.8], [7.6, 48.2], [7.8, 48.5], [8.0, 49.0], [8.3, 49.0], 
      [8.1, 49.2], [7.5, 49.2], [7.0, 49.2], [6.5, 49.4], [6.2, 49.6], [6.3, 49.9], 
      [6.1, 50.1], [6.2, 50.3], [6.0, 50.8]
    ]]
  }
};

export default function GermanCityVibeLeafletCDN() {
  const [selectedCity, setSelectedCity] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [viewMode, setViewMode] = useState('map');
  const [leafletReady, setLeafletReady] = useState(false);
  
  const mapContainerRef = useRef(null);
  const mapInstanceRef = useRef(null);
  const markersRef = useRef({});
  const geoJsonLayerRef = useRef(null);

  // --- 1. DYNAMICALLY LOAD LEAFLET (ROBUST) ---
  useEffect(() => {
    if (window.L && typeof window.L.map === 'function') {
      setLeafletReady(true);
      return;
    }

    const cssId = 'leaflet-css';
    if (!document.getElementById(cssId)) {
      const link = document.createElement('link');
      link.id = cssId;
      link.rel = 'stylesheet';
      link.href = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.css';
      document.head.appendChild(link);
    }

    const scriptId = 'leaflet-js';
    if (!document.getElementById(scriptId)) {
      const script = document.createElement('script');
      script.id = scriptId;
      script.src = 'https://unpkg.com/leaflet@1.9.4/dist/leaflet.js';
      script.async = true;
      script.onload = () => {
        if (window.L && typeof window.L.map === 'function') {
          setLeafletReady(true);
        }
      };
      document.body.appendChild(script);
    } else {
      const checkInterval = setInterval(() => {
        if (window.L && typeof window.L.map === 'function') {
          setLeafletReady(true);
          clearInterval(checkInterval);
        }
      }, 100);
      return () => clearInterval(checkInterval);
    }
  }, []);

  // --- 2. INITIALIZE MAP ---
  useEffect(() => {
    if (!leafletReady || !mapContainerRef.current || mapInstanceRef.current) return;

    try {
      const L = window.L;

      // Init Map
      const map = L.map(mapContainerRef.current, {
        center: [51.16, 10.45],
        zoom: 6,
        zoomControl: false,
        attributionControl: false
      });

      // Dark Matter Tiles (CartoDB)
      L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
        maxZoom: 19,
        subdomains: 'abcd',
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OSM</a> &copy; <a href="https://carto.com/attributions">CARTO</a>'
      }).addTo(map);

      // Add GeoJSON Border - Updated Style for better visibility with accurate borders
      const borderStyle = {
        color: '#ec4899',       // Pink
        weight: 1.5,            // Slightly thicker
        opacity: 0.8,           // More visible
        fillColor: '#ec4899',
        fillOpacity: 0.08,      // Subtle fill
        dashArray: '5, 8',      // Cyber dash pattern
        lineCap: 'round',
        lineJoin: 'round'
      };

      geoJsonLayerRef.current = L.geoJSON(GERMANY_BORDER_GEOJSON, {
        style: borderStyle,
        // Optional: Add interaction to the border itself
        onEachFeature: (feature, layer) => {
          layer.bindPopup("Bundesrepublik Deutschland", { 
            closeButton: false, 
            className: 'custom-popup-border' 
          });
        }
      }).addTo(map);

      mapInstanceRef.current = map;
    } catch (error) {
      console.error("Leaflet init error:", error);
    }

    return () => {
      if (mapInstanceRef.current) {
        mapInstanceRef.current.remove();
        mapInstanceRef.current = null;
      }
    };
  }, [leafletReady]);

  // --- 3. HANDLE MARKERS & UPDATES ---
  const filteredCities = useMemo(() => {
    return CITIES.filter(c => 
      c.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
      c.state.toLowerCase().includes(searchTerm.toLowerCase()) ||
      c.vibe.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [searchTerm]);

  const sortedByPop = [...filteredCities].sort((a, b) => b.population - a.population);

  useEffect(() => {
    if (!mapInstanceRef.current || !leafletReady) return;
    const L = window.L;
    const map = mapInstanceRef.current;

    Object.keys(markersRef.current).forEach(id => {
      if (!filteredCities.find(c => c.id === parseInt(id))) {
        markersRef.current[id].remove();
        delete markersRef.current[id];
      }
    });

    filteredCities.forEach(city => {
      const isSelected = selectedCity?.id === city.id;
      
      const customIcon = L.divIcon({
        className: 'custom-pin', 
        html: `
          <div style="position: relative; display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;">
             ${isSelected ? `<div style="position: absolute; width: 32px; height: 32px; border-radius: 9999px; border: 1px solid ${city.color}; opacity: 0.5; animation: ping 1s cubic-bezier(0, 0, 0.2, 1) infinite;"></div>` : ''}
             <div style="width: 12px; height: 12px; border-radius: 9999px; background-color: ${isSelected ? '#fff' : city.color}; box-shadow: 0 0 10px ${city.color}; transform: scale(${isSelected ? 1.5 : 1}); transition: all 0.3s;"></div>
          </div>
        `,
        iconSize: [30, 30],
        iconAnchor: [15, 15]
      });

      if (markersRef.current[city.id]) {
        markersRef.current[city.id].setIcon(customIcon);
        markersRef.current[city.id].setZIndexOffset(isSelected ? 1000 : 0);
      } else {
        const marker = L.marker([city.lat, city.lon], { icon: customIcon })
          .addTo(map)
          .on('click', () => {
            setSelectedCity(city);
            map.flyTo([city.lat, city.lon], 9, { duration: 1.5 });
          });
        markersRef.current[city.id] = marker;
      }
    });
  }, [filteredCities, selectedCity, leafletReady]);

  useEffect(() => {
    if (selectedCity && mapInstanceRef.current) {
      mapInstanceRef.current.flyTo([selectedCity.lat, selectedCity.lon], 9, { duration: 1.5 });
    }
  }, [selectedCity]);

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans overflow-hidden relative selection:bg-pink-500 selection:text-white flex flex-col">
      
      <style>{`
        @keyframes ping {
          75%, 100% { transform: scale(2); opacity: 0; }
        }
        
        .leaflet-pane { z-index: 0; }
        .leaflet-control-container { display: none; }
        .leaflet-zoom-anim .leaflet-zoom-animated { transition: transform 0.25s cubic-bezier(0,0,0.25,1); }
        
        .custom-scrollbar::-webkit-scrollbar { width: 4px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: rgba(30, 41, 59, 0.5); }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: rgba(236, 72, 153, 0.5); border-radius: 10px; }

        /* Custom Popup for Border */
        .custom-popup-border .leaflet-popup-content-wrapper {
          background: rgba(15, 23, 42, 0.9);
          color: #ec4899;
          font-weight: bold;
          border: 1px solid #ec4899;
          font-family: sans-serif;
        }
        .custom-popup-border .leaflet-popup-tip {
          background: rgba(15, 23, 42, 0.9);
        }
      `}</style>

      {/* Header */}
      <header className="relative z-50 px-6 py-4 flex flex-col md:flex-row justify-between items-center border-b border-slate-800/50 backdrop-blur-md bg-slate-950/80">
        <div className="flex items-center gap-3 mb-4 md:mb-0">
          <div className="p-2 bg-gradient-to-tr from-pink-500 to-violet-600 rounded-lg shadow-lg shadow-pink-500/20">
            <MapIcon className="w-6 h-6 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
              GERMANY.VIBE
            </h1>
            <div className="text-xs text-slate-400 uppercase tracking-widest flex items-center gap-1">
              <span className={`w-2 h-2 rounded-full transition-colors duration-500 ${leafletReady ? 'bg-green-500 shadow-[0_0_5px_rgba(34,197,94,0.5)]' : 'bg-yellow-500 animate-pulse'}`}></span>
              {leafletReady ? 'Engine Ready' : 'Loading Engine...'}
            </div>
          </div>
        </div>

        <div className="flex items-center gap-4 w-full md:w-auto">
          <div className="relative group w-full md:w-64">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 group-focus-within:text-pink-400 transition-colors" />
            <input 
              type="text" 
              placeholder="Search city..." 
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full bg-slate-900/50 border border-slate-700 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:border-pink-500/50 focus:ring-1 focus:ring-pink-500/50 transition-all placeholder:text-slate-600"
            />
          </div>
          
          <div className="flex bg-slate-900/50 p-1 rounded-full border border-slate-700">
             <button onClick={() => setViewMode('map')} className={`px-4 py-1.5 rounded-full text-xs font-medium transition-colors ${viewMode === 'map' ? 'bg-slate-700 text-white' : 'text-slate-400 hover:text-white'}`}>Map</button>
             <button onClick={() => setViewMode('list')} className={`px-4 py-1.5 rounded-full text-xs font-medium transition-colors ${viewMode === 'list' ? 'bg-slate-700 text-white' : 'text-slate-400 hover:text-white'}`}>List</button>
          </div>
        </div>
      </header>

      {/* Main Content */}
      <main className="relative z-10 flex-1 flex flex-col md:flex-row overflow-hidden">
        
        {/* List Panel */}
        <div className={`flex-shrink-0 w-full md:w-80 border-r border-slate-800/50 bg-slate-900/50 backdrop-blur-md flex flex-col transition-all duration-500 z-20 ${viewMode === 'map' ? 'hidden md:flex' : 'flex h-full'}`}>
          <div className="p-4 border-b border-slate-800/50">
             <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider flex items-center gap-2"><TrendingUp className="w-4 h-4" /> Top Cities</h2>
          </div>
          <div className="overflow-y-auto flex-1 p-3 space-y-2 custom-scrollbar">
            {sortedByPop.map((city) => (
              <div 
                key={city.id}
                onClick={() => { setSelectedCity(city); setViewMode('map'); }}
                className={`group relative p-3 rounded-lg border cursor-pointer transition-all duration-200 ${selectedCity?.id === city.id ? 'bg-slate-800/80 border-pink-500/50 border-l-4 border-l-pink-500' : 'bg-slate-900/40 border-slate-800/50 hover:bg-slate-800 hover:border-slate-700'}`}
              >
                <div className="flex justify-between items-start">
                  <div>
                    <h3 className="font-bold text-sm text-slate-200 group-hover:text-white">{city.name}</h3>
                    <p className="text-[10px] text-slate-500 uppercase">{city.state}</p>
                  </div>
                  <div className="w-2 h-2 rounded-full shadow-sm" style={{ backgroundColor: city.color, boxShadow: `0 0 8px ${city.color}` }} />
                </div>
              </div>
            ))}
          </div>
        </div>

        {/* Map Area */}
        <div className={`relative flex-1 bg-slate-950 ${viewMode === 'list' ? 'hidden md:flex' : 'flex'}`}>
          
          <div ref={mapContainerRef} className="w-full h-full outline-none z-0" />
          
          {!leafletReady && (
            <div className="absolute inset-0 z-50 flex items-center justify-center bg-slate-950">
              <div className="flex flex-col items-center gap-4">
                 <div className="w-8 h-8 border-4 border-pink-500 border-t-transparent rounded-full animate-spin"></div>
                 <p className="text-slate-400 text-sm animate-pulse">Initializing Neural Map...</p>
              </div>
            </div>
          )}

          <div className="absolute bottom-8 right-8 flex flex-col gap-2 z-[1000]">
            <button 
              onClick={() => mapInstanceRef.current?.flyTo([51.16, 10.45], 6)} 
              className="p-3 bg-slate-800/90 text-white rounded-full hover:bg-pink-600 transition-colors shadow-xl border border-white/10"
              title="Reset View"
            >
              <Layers className="w-5 h-5" />
            </button>
          </div>

          {selectedCity && (
            <div className="absolute top-6 right-6 z-[1000] w-72 bg-slate-900/90 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-5 shadow-2xl hidden md:block animate-in fade-in slide-in-from-right-5">
              <div className="flex justify-between items-start mb-4">
                <div 
                  className="w-10 h-10 rounded-xl shadow-lg flex items-center justify-center border border-white/10"
                  style={{ background: `linear-gradient(135deg, ${selectedCity.color}44, ${selectedCity.color}88)` }}
                >
                  <MapPin className="text-white w-5 h-5" />
                </div>
                <button onClick={() => setSelectedCity(null)} className="text-slate-500 hover:text-white transition-colors"><X className="w-5 h-5" /></button>
              </div>
              <h2 className="text-2xl font-bold text-white mb-0">{selectedCity.name}</h2>
              <p className="text-pink-500 font-medium text-xs tracking-wide uppercase mb-4">{selectedCity.state}</p>
              
              <div className="space-y-3">
                <div className="flex items-center gap-3 p-2 rounded-lg bg-slate-800/50 border border-slate-700/30">
                  <Users className="text-slate-400 w-4 h-4" />
                  <div>
                    <p className="text-[10px] text-slate-500 uppercase">Bevölkerung</p>
                    <p className="text-slate-200 font-mono text-sm">{selectedCity.population.toLocaleString()}</p>
                  </div>
                </div>
                <div className="flex items-center gap-3 p-2 rounded-lg bg-slate-800/50 border border-slate-700/30">
                  <Info className="text-slate-400 w-4 h-4" />
                  <div>
                    <p className="text-[10px] text-slate-500 uppercase">The Vibe</p>
                    <p className="text-slate-200 text-sm">{selectedCity.vibe}</p>
                  </div>
                </div>
              </div>
            </div>
          )}

           {selectedCity && (
            <div className="md:hidden fixed inset-0 z-[2000] bg-black/60 backdrop-blur-[2px] flex items-end" onClick={() => setSelectedCity(null)}>
              <div className="w-full bg-slate-900 rounded-t-2xl border-t border-slate-700 p-6 animate-in slide-in-from-bottom-full" onClick={e => e.stopPropagation()}>
                 <div className="flex items-center justify-between mb-4">
                    <h2 className="text-xl font-bold">{selectedCity.name}</h2>
                    <button onClick={() => setSelectedCity(null)}><X className="w-5 h-5 text-slate-400"/></button>
                 </div>
                 <div className="grid grid-cols-2 gap-3">
                    <div className="bg-slate-800 p-3 rounded-lg">
                        <span className="text-xs text-slate-500 block">Vibe</span>
                        <span className="text-sm">{selectedCity.vibe}</span>
                    </div>
                    <div className="bg-slate-800 p-3 rounded-lg">
                        <span className="text-xs text-slate-500 block">Pop</span>
                        <span className="text-sm font-mono">{(selectedCity.population / 1000000).toFixed(2)}M</span>
                    </div>
                 </div>
              </div>
            </div>
          )}
        </div>
      </main>
    </div>
  );
}
