import React, { useState, useMemo } from 'react';
import { Map, MapPin, Users, Navigation, Search, Info, X, ChevronRight, TrendingUp } from 'lucide-react';

// --- DATA SET: Top German Cities with approx Coordinates ---
// Coordinates are roughly boundaries: Lat 47-55, Lon 6-15
const CITIES = [
  { id: 1, name: 'Berlin', population: 3664000, state: 'Berlin', lat: 52.52, lon: 13.40, vibe: 'Techno & History', color: 'from-pink-500 to-rose-500' },
  { id: 2, name: 'Hamburg', population: 1852000, state: 'Hamburg', lat: 53.55, lon: 9.99, vibe: 'Harbor & Bricks', color: 'from-blue-400 to-cyan-300' },
  { id: 3, name: 'München', population: 1488000, state: 'Bayern', lat: 48.13, lon: 11.58, vibe: 'Laptops & Lederhosen', color: 'from-blue-600 to-indigo-500' },
  { id: 4, name: 'Köln', population: 1083000, state: 'NRW', lat: 50.93, lon: 6.96, vibe: 'Carnival & Cathedral', color: 'from-red-500 to-orange-400' },
  { id: 5, name: 'Frankfurt', population: 764000, state: 'Hessen', lat: 50.11, lon: 8.68, vibe: 'Banks & Skyscrapers', color: 'from-emerald-400 to-teal-500' },
  { id: 6, name: 'Stuttgart', population: 630000, state: 'Ba-Wü', lat: 48.77, lon: 9.18, vibe: 'Cars & Vineyards', color: 'from-yellow-400 to-orange-500' },
  { id: 7, name: 'Düsseldorf', population: 620000, state: 'NRW', lat: 51.22, lon: 6.77, vibe: 'Fashion & Altbier', color: 'from-purple-500 to-indigo-400' },
  { id: 8, name: 'Leipzig', population: 601000, state: 'Sachsen', lat: 51.33, lon: 12.37, vibe: 'Hypezig & Culture', color: 'from-yellow-300 to-amber-500' },
  { id: 9, name: 'Dortmund', population: 586000, state: 'NRW', lat: 51.51, lon: 7.46, vibe: 'Football & Steel', color: 'from-yellow-400 to-yellow-600' },
  { id: 10, name: 'Essen', population: 582000, state: 'NRW', lat: 51.45, lon: 7.01, vibe: 'Green Capital & Coal', color: 'from-emerald-500 to-green-600' },
  { id: 11, name: 'Bremen', population: 566000, state: 'Bremen', lat: 53.07, lon: 8.80, vibe: 'Musicians & Space', color: 'from-red-400 to-red-600' },
  { id: 12, name: 'Dresden', population: 556000, state: 'Sachsen', lat: 51.05, lon: 13.73, vibe: 'Baroque & Future', color: 'from-orange-300 to-amber-600' },
  { id: 13, name: 'Hannover', population: 535000, state: 'Niedersachsen', lat: 52.37, lon: 9.73, vibe: 'Expo & Gardens', color: 'from-green-400 to-emerald-400' },
  { id: 14, name: 'Nürnberg', population: 515000, state: 'Bayern', lat: 49.45, lon: 11.07, vibe: 'Toys & Castle', color: 'from-red-600 to-rose-700' },
  { id: 15, name: 'Duisburg', population: 495000, state: 'NRW', lat: 51.43, lon: 6.76, vibe: 'Logistics & Water', color: 'from-slate-400 to-slate-600' },
  { id: 16, name: 'Bochum', population: 363000, state: 'NRW', lat: 51.48, lon: 7.21, vibe: 'Mining & Musical', color: 'from-blue-500 to-blue-700' },
  { id: 17, name: 'Wuppertal', population: 355000, state: 'NRW', lat: 51.25, lon: 7.19, vibe: 'Suspension Railway', color: 'from-green-500 to-teal-600' },
  { id: 18, name: 'Bielefeld', population: 334000, state: 'NRW', lat: 52.03, lon: 8.53, vibe: 'Does it exist?', color: 'from-gray-400 to-gray-500' },
  { id: 19, name: 'Bonn', population: 331000, state: 'NRW', lat: 50.73, lon: 7.09, vibe: 'Politics & Beethoven', color: 'from-blue-300 to-indigo-300' },
  { id: 20, name: 'Münster', population: 317000, state: 'NRW', lat: 51.96, lon: 7.62, vibe: 'Bicycles & Students', color: 'from-green-300 to-lime-400' },
  { id: 21, name: 'Karlsruhe', population: 308000, state: 'Ba-Wü', lat: 49.00, lon: 8.40, vibe: 'Justice & Tech', color: 'from-yellow-500 to-orange-400' },
  { id: 22, name: 'Mannheim', population: 311000, state: 'Ba-Wü', lat: 49.48, lon: 8.46, vibe: 'Grid City & Pop', color: 'from-purple-400 to-pink-400' },
  { id: 23, name: 'Augsburg', population: 296000, state: 'Bayern', lat: 48.37, lon: 10.89, vibe: 'Fugger & Renaissance', color: 'from-red-400 to-orange-300' },
  { id: 24, name: 'Wiesbaden', population: 278000, state: 'Hessen', lat: 50.07, lon: 8.23, vibe: 'Spa & Casino', color: 'from-teal-400 to-emerald-300' },
  { id: 25, name: 'Kiel', population: 246000, state: 'SH', lat: 54.32, lon: 10.12, vibe: 'Sailing & Navy', color: 'from-blue-400 to-cyan-500' },
];

// Helper to normalize coordinates for the SVG map
// Germany bounds approx: Lat 47.2 - 55.1, Lon 5.8 - 15.1
const normalize = (val, min, max) => (val - min) / (max - min);

export default function GermanCityVibe() {
  const [selectedCity, setSelectedCity] = useState(null);
  const [searchTerm, setSearchTerm] = useState('');
  const [viewMode, setViewMode] = useState('map'); // 'map' or 'list'

  // Filter logic
  const filteredCities = useMemo(() => {
    return CITIES.filter(c => 
      c.name.toLowerCase().includes(searchTerm.toLowerCase()) || 
      c.state.toLowerCase().includes(searchTerm.toLowerCase()) ||
      c.vibe.toLowerCase().includes(searchTerm.toLowerCase())
    );
  }, [searchTerm]);

  const sortedByPop = [...filteredCities].sort((a, b) => b.population - a.population);

  return (
    <div className="min-h-screen bg-slate-950 text-slate-100 font-sans overflow-hidden relative selection:bg-pink-500 selection:text-white">
      {/* Background Decor */}
      <div className="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-purple-900/20 rounded-full blur-[120px] pointer-events-none" />
      <div className="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-blue-900/20 rounded-full blur-[120px] pointer-events-none" />

      {/* Header */}
      <header className="relative z-10 px-6 py-6 flex flex-col md:flex-row justify-between items-center border-b border-slate-800/50 backdrop-blur-md">
        <div className="flex items-center gap-3 mb-4 md:mb-0">
          <div className="p-2 bg-gradient-to-tr from-pink-500 to-violet-600 rounded-lg shadow-lg shadow-pink-500/20">
            <Map className="w-6 h-6 text-white" />
          </div>
          <div>
            <h1 className="text-2xl font-bold tracking-tight bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400">
              GERMANY.VIBE
            </h1>
            <p className="text-xs text-slate-400 uppercase tracking-widest">Major City Explorer</p>
          </div>
        </div>

        <div className="flex items-center gap-4 w-full md:w-auto">
          <div className="relative group w-full md:w-64">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-slate-500 group-focus-within:text-pink-400 transition-colors" />
            <input 
              type="text" 
              placeholder="Search city, state, vibe..." 
              value={searchTerm}
              onChange={(e) => setSearchTerm(e.target.value)}
              className="w-full bg-slate-900/50 border border-slate-700 rounded-full py-2 pl-10 pr-4 text-sm focus:outline-none focus:border-pink-500/50 focus:ring-1 focus:ring-pink-500/50 transition-all placeholder:text-slate-600"
            />
          </div>
          
          <div className="flex bg-slate-900/50 p-1 rounded-full border border-slate-700">
            <button 
              onClick={() => setViewMode('map')}
              className={`px-4 py-1.5 rounded-full text-xs font-medium transition-all ${viewMode === 'map' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}
            >
              Map
            </button>
            <button 
              onClick={() => setViewMode('list')}
              className={`px-4 py-1.5 rounded-full text-xs font-medium transition-all ${viewMode === 'list' ? 'bg-slate-700 text-white shadow-sm' : 'text-slate-400 hover:text-white'}`}
            >
              List
            </button>
          </div>
        </div>
      </header>

      {/* Main Content Area */}
      <main className="relative z-0 h-[calc(100vh-88px)] flex flex-col md:flex-row overflow-hidden">
        
        {/* Left Panel: City List / Stats */}
        <div className={`
          flex-shrink-0 w-full md:w-96 border-r border-slate-800/50 bg-slate-900/30 backdrop-blur-sm flex flex-col transition-all duration-500
          ${viewMode === 'map' ? 'hidden md:flex' : 'flex'}
        `}>
          <div className="p-4 border-b border-slate-800/50">
            <h2 className="text-sm font-semibold text-slate-400 uppercase tracking-wider mb-2 flex items-center gap-2">
              <TrendingUp className="w-4 h-4" /> Top Population
            </h2>
          </div>
          <div className="overflow-y-auto flex-1 p-4 space-y-3 custom-scrollbar">
            {sortedByPop.map((city, idx) => (
              <div 
                key={city.id}
                onClick={() => setSelectedCity(city)}
                className={`
                  group relative p-4 rounded-xl border cursor-pointer transition-all duration-300
                  ${selectedCity?.id === city.id 
                    ? 'bg-slate-800/80 border-pink-500/50 shadow-lg shadow-pink-500/10 translate-x-2' 
                    : 'bg-slate-900/40 border-slate-800 hover:bg-slate-800 hover:border-slate-700'}
                `}
              >
                <div className="flex justify-between items-start">
                  <div>
                    <div className="flex items-center gap-2">
                      <span className={`text-xs font-mono opacity-50`}>#{idx + 1}</span>
                      <h3 className="font-bold text-slate-200 group-hover:text-white">{city.name}</h3>
                    </div>
                    <p className="text-xs text-slate-500 mt-0.5">{city.state}</p>
                  </div>
                  <div className={`w-2 h-2 rounded-full bg-gradient-to-r ${city.color}`} />
                </div>
                <div className="mt-3 flex items-center justify-between text-xs text-slate-400">
                  <span className="flex items-center gap-1"><Users className="w-3 h-3" /> {(city.population / 1000000).toFixed(2)}M</span>
                  <span className="italic opacity-0 group-hover:opacity-100 transition-opacity text-pink-400">Explore &rarr;</span>
                </div>
              </div>
            ))}
            
            {filteredCities.length === 0 && (
              <div className="text-center py-12 text-slate-600">
                <p>No cities found.</p>
              </div>
            )}
          </div>
        </div>

        {/* Center: The Visualization */}
        <div className={`
          relative flex-1 bg-slate-950 overflow-hidden flex items-center justify-center
          ${viewMode === 'list' ? 'hidden md:flex' : 'flex'}
        `}>
          
          {/* Grid Lines */}
          <div className="absolute inset-0 opacity-[0.03]" 
            style={{ 
              backgroundImage: 'linear-gradient(#fff 1px, transparent 1px), linear-gradient(90deg, #fff 1px, transparent 1px)', 
              backgroundSize: '40px 40px' 
            }} 
          />

          {/* Map Container */}
          <div className="relative w-full max-w-2xl aspect-[3/4] p-8 md:p-12">
            {/* SVG Map Layer */}
            <svg viewBox="0 0 100 130" className="w-full h-full drop-shadow-2xl">
              <defs>
                <filter id="glow">
                  <feGaussianBlur stdDeviation="2.5" result="coloredBlur"/>
                  <feMerge>
                    <feMergeNode in="coloredBlur"/>
                    <feMergeNode in="SourceGraphic"/>
                  </feMerge>
                </filter>
              </defs>

              {/* Roughly sketched German outline purely for visual context - extremely simplified polygon */}
              <path 
                d="M35,5 L55,2 L70,8 L85,5 L95,15 L98,40 L90,55 L95,85 L80,100 L90,125 L60,128 L40,125 L30,120 L15,110 L5,90 L2,60 L10,50 L5,30 L15,15 Z"
                fill="none"
                stroke="rgba(255,255,255,0.05)"
                strokeWidth="0.5"
                className="pointer-events-none"
              />

              {/* Connections (Just for vibe) */}
              {filteredCities.map((city, i) => {
                 // Create random connections for "network" feel, just for visual flair
                 if (i % 3 === 0 && i < filteredCities.length - 1) {
                   const next = filteredCities[i+1];
                   const x1 = normalize(city.lon, 5.8, 15.1) * 100;
                   const y1 = 100 - normalize(city.lat, 47.2, 55.1) * 100; // Invert lat
                   const x2 = normalize(next.lon, 5.8, 15.1) * 100;
                   const y2 = 100 - normalize(next.lat, 47.2, 55.1) * 100;
                   return (
                     <line 
                      key={`line-${i}`} x1={x1} y1={y1} x2={x2} y2={y2} 
                      stroke="url(#grad1)" 
                      strokeWidth="0.2" 
                      opacity="0.2"
                      className="animate-pulse"
                    />
                   )
                 }
                 return null;
              })}
              
              <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="0%">
                <stop offset="0%" stopColor="#ec4899" />
                <stop offset="100%" stopColor="#8b5cf6" />
              </linearGradient>

              {/* Cities */}
              {filteredCities.map((city) => {
                const x = normalize(city.lon, 5.8, 15.1) * 100;
                const y = 100 - normalize(city.lat, 47.2, 55.1) * 100; // Invert lat because SVG y grows downwards
                
                const isSelected = selectedCity?.id === city.id;

                return (
                  <g 
                    key={city.id} 
                    transform={`translate(${x}, ${y})`}
                    onClick={() => setSelectedCity(city)}
                    className="cursor-pointer transition-all duration-300 hover:opacity-100"
                    style={{ opacity: isSelected ? 1 : 0.8 }}
                  >
                    {/* Ripple Effect for selected */}
                    {isSelected && (
                      <circle r="8" fill="none" stroke="rgba(236, 72, 153, 0.5)" strokeWidth="0.5">
                        <animate attributeName="r" from="2" to="12" dur="1.5s" repeatCount="indefinite" />
                        <animate attributeName="opacity" from="1" to="0" dur="1.5s" repeatCount="indefinite" />
                      </circle>
                    )}

                    {/* Main Dot */}
                    <circle 
                      r={city.population > 1000000 ? 1.5 : 0.8} 
                      fill={isSelected ? '#ec4899' : '#fff'}
                      filter={isSelected ? 'url(#glow)' : ''}
                      className="transition-colors duration-300"
                    />
                    
                    {/* Hover Area (invisible bigger target) */}
                    <circle r="4" fill="transparent" />

                    {/* Label (Only show for big cities or selected) */}
                    {(city.population > 600000 || isSelected) && (
                      <text 
                        y="-3" 
                        fontSize="2.5" 
                        fill={isSelected ? '#ec4899' : 'rgba(255,255,255,0.6)'}
                        textAnchor="middle" 
                        className={`font-sans tracking-wide uppercase transition-all duration-300 ${isSelected ? 'font-bold' : 'font-thin'}`}
                      >
                        {city.name}
                      </text>
                    )}
                  </g>
                );
              })}
            </svg>
            
            {/* Map Legend/Compass */}
            <div className="absolute bottom-8 right-8 flex flex-col items-center opacity-30 pointer-events-none">
              <Navigation className="w-8 h-8 text-white mb-1" style={{ transform: 'rotate(0deg)' }} />
              <span className="text-[10px] tracking-[0.2em] text-white">NORTH</span>
            </div>
          </div>

          {/* Floating Details Card (Desktop Overlay) */}
          {selectedCity && (
            <div className="absolute top-8 right-8 w-80 bg-slate-900/90 backdrop-blur-xl border border-slate-700/50 rounded-2xl p-6 shadow-2xl transform transition-all duration-500 ease-out hidden md:block animate-in fade-in slide-in-from-right-10">
              <div className="flex justify-between items-start mb-6">
                <div className={`w-12 h-12 rounded-2xl bg-gradient-to-br ${selectedCity.color} shadow-lg flex items-center justify-center`}>
                  <MapPin className="text-white w-6 h-6" />
                </div>
                <button onClick={() => setSelectedCity(null)} className="text-slate-500 hover:text-white transition-colors">
                  <X className="w-5 h-5" />
                </button>
              </div>
              
              <h2 className="text-3xl font-bold text-white mb-1">{selectedCity.name}</h2>
              <p className="text-pink-500 font-medium text-sm tracking-wide uppercase mb-6">{selectedCity.state}</p>
              
              <div className="space-y-4">
                <div className="flex items-center gap-3 p-3 rounded-lg bg-slate-800/50">
                  <Users className="text-slate-400 w-5 h-5" />
                  <div>
                    <p className="text-xs text-slate-500 uppercase">Population</p>
                    <p className="text-slate-200 font-mono">{selectedCity.population.toLocaleString()}</p>
                  </div>
                </div>
                
                <div className="flex items-center gap-3 p-3 rounded-lg bg-slate-800/50">
                  <Info className="text-slate-400 w-5 h-5" />
                  <div>
                    <p className="text-xs text-slate-500 uppercase">The Vibe</p>
                    <p className="text-slate-200">{selectedCity.vibe}</p>
                  </div>
                </div>
              </div>

              <div className="mt-6 pt-6 border-t border-slate-800">
                <div className="flex justify-between items-center text-xs text-slate-500">
                  <span>Lat: {selectedCity.lat}</span>
                  <span>Lon: {selectedCity.lon}</span>
                </div>
              </div>
            </div>
          )}
        </div>
      </main>

      {/* Mobile Drawer for Details */}
      {selectedCity && (
        <div className="md:hidden fixed inset-0 z-50 bg-black/50 backdrop-blur-sm flex items-end" onClick={() => setSelectedCity(null)}>
          <div className="w-full bg-slate-900 rounded-t-3xl border-t border-slate-700 p-6 animate-in slide-in-from-bottom-full" onClick={e => e.stopPropagation()}>
            <div className="flex items-center gap-4 mb-6">
              <div className={`w-12 h-12 rounded-xl bg-gradient-to-br ${selectedCity.color} flex items-center justify-center flex-shrink-0`}>
                <MapPin className="text-white w-6 h-6" />
              </div>
              <div>
                <h2 className="text-2xl font-bold text-white">{selectedCity.name}</h2>
                <p className="text-pink-500 text-sm">{selectedCity.state}</p>
              </div>
            </div>
            <div className="grid grid-cols-2 gap-4 mb-6">
              <div className="bg-slate-800 p-3 rounded-xl">
                 <p className="text-xs text-slate-500 mb-1">Population</p>
                 <p className="font-mono">{selectedCity.population.toLocaleString()}</p>
              </div>
              <div className="bg-slate-800 p-3 rounded-xl">
                 <p className="text-xs text-slate-500 mb-1">Vibe</p>
                 <p>{selectedCity.vibe}</p>
              </div>
            </div>
            <button 
              onClick={() => setSelectedCity(null)}
              className="w-full py-3 bg-slate-800 rounded-xl font-semibold text-slate-300"
            >
              Close
            </button>
          </div>
        </div>
      )}
    </div>
  );
}
